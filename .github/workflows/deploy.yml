name: Deploy to Development Server

on:
  push:
    branches:
      - ec2test   # ê°œë°œ í…ŒìŠ¤íŠ¸ìš© ë¸Œëžœì¹˜
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Deploy to Development EC2
      run: |
        # SSH í‚¤ ì„¤ì •
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa

        # SSH known_hosts ì„¤ì •
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

        # Git rsync
        rsync -avz --delete --exclude=".git" --exclude="node_modules" -e "ssh -o StrictHostKeyChecking=no" ./ ubuntu@${{ secrets.EC2_HOST }}:/home/ubuntu/RealWaveFlow/

        # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (ê°œë°œ í™˜ê²½ìš©)
        cat > deploy.sh << 'EOF'
        #!/bin/bash
        set -e

        echo "ðŸš€ Starting DEVELOPMENT deployment..."
        echo "Branch: ec2test"
        echo "Commit: ${{ github.sha }}"
        echo "Author: ${{ github.actor }}"
        echo "================================"
        
        cd /home/ubuntu/RealWaveFlow

        # .env íŒŒì¼ ìƒì„± (ê°œë°œ í™˜ê²½ ì„¤ì •)
        echo "Creating development environment file..."
        cat > ./backend/.env << 'ENVEOF'
        DB_HOST=${{ secrets.DB_HOST }}
        DB_PORT=${{ secrets.DB_PORT }}
        DB_USERNAME=${{ secrets.DB_USERNAME }}
        DB_PASSWORD=${{ secrets.DB_PASSWORD }}
        DB_NAME=postgres
        JWT_SECRET=${{ secrets.JWT_SECRET }}
        RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}
        FRONTEND_URL=https://waveflow.pro
        EMAIL_USER=${{ secrets.EMAIL_USER }}
        EMAIL_PASS=${{ secrets.EMAIL_PASS }}
        GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
        GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
        GOOGLE_CALLBACK_URL=https://waveflow.pro/auth/google/callback
        AWS_REGION=${{ secrets.AWS_REGION }}
        AWS_ACCESS_KEY_ID_FOR_GITACTIONS=${{ secrets.AWS_ACCESS_KEY_ID_FOR_GITACTIONS }}
        AWS_SECRET_ACCESS_KEY_FOR_GITACTIONS=${{ secrets.AWS_SECRET_ACCESS_KEY_FOR_GITACTIONS }}
        AWS_S3_BUCKET_NAME=${{ secrets.AWS_S3_BUCKET_NAME }}
        MY_QUEUE_URL=${{ secrets.MY_QUEUE_URL }}
        NODE_ENV=development
        ENVEOF

        echo "âœ… Environment file created successfully"

        # Nginx ì„¤ì • ì—…ë°ì´íŠ¸
        echo "Updating Nginx configuration..."
        
        # Nginx ì„¤ì • íŒŒì¼ ìƒì„±
        cat > ./nginx-waveflow.conf << 'NGINXEOF'
        server {
            listen 80;
            server_name waveflow.pro www.waveflow.pro;
            
            # HTTPì—ì„œ HTTPSë¡œ ë¦¬ë‹¤ì´ë ‰ì…˜
            return 301 https://$host$request_uri;
        }

        server {
            listen 443 ssl;
            server_name waveflow.pro www.waveflow.pro;
            
            # SSL ì¸ì¦ì„œ ì„¤ì • (Certbotì´ ìžë™ìœ¼ë¡œ ì„¤ì •í•¨)
            ssl_certificate /etc/letsencrypt/live/waveflow.pro/fullchain.pem;
            ssl_certificate_key /etc/letsencrypt/live/waveflow.pro/privkey.pem;
            
            # í”„ë¡ íŠ¸ì—”ë“œ ì •ì  íŒŒì¼ (ë¹Œë“œ íŒŒì¼)
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                proxy_pass http://localhost:3000;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
            }
            
            # ë°±ì—”ë“œ assets ê²½ë¡œ - ëª…í™•ížˆ êµ¬ë¶„
            location /api/assets/ {
                proxy_pass http://localhost:8080/api/assets/;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }
            
            # ê¸°ë³¸ ê²½ë¡œ - í”„ë¡ íŠ¸ì—”ë“œë¡œ ì „ë‹¬
            location / {
                proxy_pass http://localhost:3000;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                
                # WebSocket ì§€ì›
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
                proxy_cache_bypass $http_upgrade;
                
                # React Router ì§€ì›
                try_files $uri $uri/ /index.html;
            }
            
            # Socket.io ê²½ë¡œ
            location /socket.io/ {
                proxy_pass http://localhost:3000/socket.io/;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_cache_bypass $http_upgrade;
            }
            
            # ì•Œë¦¼ WebSocket ê²½ë¡œ
            location /notifications {
                proxy_pass http://localhost:3000/notifications;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_cache_bypass $http_upgrade;
            }
            
            # API ìš”ì²­
            location /api/ {
                proxy_pass http://localhost:8080/;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }
        }
        NGINXEOF
        
        # Nginx ì„¤ì • ì ìš©
        sudo cp ./nginx-waveflow.conf /etc/nginx/sites-available/default
        sudo nginx -t && sudo systemctl restart nginx
        echo "âœ… Nginx configuration updated successfully"

        # Docker ì •ë¦¬ ë° ìž¬ë¹Œë“œ
        echo "Starting Docker deployment..."
        sudo docker-compose down --remove-orphans || true
        sudo docker system prune -af --volumes
        sudo docker builder prune -af

        # í™˜ê²½ë³€ìˆ˜ ì„¤ì • ë° ë¹Œë“œ
        echo "Building containers..."
        export VITE_API_URL=https://waveflow.pro/api
        sudo -E docker-compose build --no-cache
        sudo docker-compose up -d

        # ì„œë¹„ìŠ¤ ì‹œìž‘ ëŒ€ê¸°
        echo "Waiting for services to start...!"
        sleep 30

        # ìƒíƒœ í™•ì¸
        echo "=== Container Status ==="
        sudo docker-compose ps

        echo "=== Backend Container Logs (Development) ==="
        sudo docker-compose logs --tail=50 backend

        # Health check
        echo "=== Health Check ==="
        echo "Testing backend (port 8080)..."
        curl -f http://localhost:8080/health || echo "Backend health check failed"

        echo "Testing frontend (port 3000)..."
        curl -f http://localhost:3000 || echo "Frontend health check failed"

        echo "================================"
        echo "âœ… DEVELOPMENT deployment completed!"
        echo "ðŸ”— Backend: https://waveflow.pro/api"
        echo "ðŸ”— Frontend: https://waveflow.pro"
        echo "ðŸ”— API Docs: https://waveflow.pro/api"
        echo "================================"
        EOF

        # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        scp -o StrictHostKeyChecking=no deploy.sh ubuntu@${{ secrets.EC2_HOST }}:/home/ubuntu/deploy.sh
        ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} "chmod +x /home/ubuntu/deploy.sh && /home/ubuntu/deploy.sh"

    - name: Notify Team on Success
      if: success()
      run: |
        curl -X POST -H 'Content-type: application/json' --data '{
          "text": "ðŸ§ª ê°œë°œ ì„œë²„ ë°°í¬ ì„±ê³µ!\nðŸ“‹ Branch: `ec2test`\nðŸ‘¤ Author: `${{ github.actor }}`\nðŸ”— Backend: https://waveflow.pro/api\nðŸ”— Frontend: https://waveflow.pro\nðŸ’¡ íŒ€ì›ë“¤ì€ ì´ì œ ì„œë²„ì—ì„œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥í•©ë‹ˆë‹¤!"
        }' ${{ secrets.SLACK_WEBHOOK_URL }}

    - name: Notify Team on Failure
      if: failure()
      run: |
        curl -X POST -H 'Content-type: application/json' --data '{
          "text": "âŒ ê°œë°œ ì„œë²„ ë°°í¬ ì‹¤íŒ¨\nðŸ“‹ Branch: `ec2test`\nðŸ‘¤ Author: `${{ github.actor }}`\nðŸ” GitHub Actionsì—ì„œ ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
        }' ${{ secrets.SLACK_WEBHOOK_URL }}
