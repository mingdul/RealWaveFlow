name: Deploy to Development Server

on:
  push:
    branches:
      - ec2test   # ê°œë°œ í…ŒìŠ¤íŠ¸ìš© ë¸Œëžœì¹˜
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Deploy to Development EC2
      run: |
        # SSH í‚¤ ì„¤ì •
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa

        # SSH known_hosts ì„¤ì •
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

        # Git rsync
        rsync -avz --delete --exclude=".git" --exclude="node_modules" -e "ssh -o StrictHostKeyChecking=no" ./ ubuntu@${{ secrets.EC2_HOST }}:/home/ubuntu/RealWaveFlow/

        # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (ê°œë°œ í™˜ê²½ìš©)
        cat > deploy.sh << 'EOF'
        #!/bin/bash
        set -e

        echo "ðŸš€ Starting DEVELOPMENT deployment..."
        echo "Branch: ec2test"
        echo "Commit: ${{ github.sha }}"
        echo "Author: ${{ github.actor }}"
        echo "================================"
        
        cd /home/ubuntu/RealWaveFlow

        # .env íŒŒì¼ ìƒì„± (ê°œë°œ í™˜ê²½ ì„¤ì •)
        echo "Creating development environment file....."
        cat > ./backend/.env << 'ENVEOF'
        DB_HOST=${{ secrets.DB_HOST }}
        DB_PORT=${{ secrets.DB_PORT }}
        DB_USERNAME=${{ secrets.DB_USERNAME }}
        DB_PASSWORD=${{ secrets.DB_PASSWORD }}
        DB_NAME=postgres
        JWT_SECRET=${{ secrets.JWT_SECRET }}
        RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}
        FRONTEND_URL=${{ secrets.FRONTEND_URL }}
        EMAIL_USER=${{ secrets.EMAIL_USER }}
        EMAIL_PASS=${{ secrets.EMAIL_PASS }}
        GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
        GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
        GOOGLE_CALLBACK_URL=${{ secrets.GOOGLE_CALLBACK_URL }}
        AWS_REGION=${{ secrets.AWS_REGION }}
        AWS_ACCESS_KEY_ID_FOR_GITACTIONS=${{ secrets.AWS_ACCESS_KEY_ID_FOR_GITACTIONS }}
        AWS_SECRET_ACCESS_KEY_FOR_GITACTIONS=${{ secrets.AWS_SECRET_ACCESS_KEY_FOR_GITACTIONS }}
        AWS_S3_BUCKET_NAME=${{ secrets.AWS_S3_BUCKET_NAME }}
        MY_QUEUE_URL=${{ secrets.MY_QUEUE_URL }}
        NODE_ENV=development
        ENVEOF

        echo "âœ… Environment file created successfully"

        # Docker ì •ë¦¬ ë° ìž¬ë¹Œë“œ
        echo "Starting Docker deployment..."
        sudo docker-compose down --remove-orphans || true
        sudo docker system prune -af --volumes
        sudo docker builder prune -af

        # í™˜ê²½ë³€ìˆ˜ ì„¤ì • ë° ë¹Œë“œ
        echo "Building containers..."
        export VITE_API_URL=http://${{ secrets.EC2_HOST }}:8080
        sudo -E docker-compose build --no-cache
        sudo docker-compose up -d

        # ì„œë¹„ìŠ¤ ì‹œìž‘ ëŒ€ê¸°
        echo "Waiting for services to start..."
        sleep 30

        # ìƒíƒœ í™•ì¸
        echo "=== Container Status ==="
        sudo docker-compose ps

        echo "=== Backend Container Logs (Development) ==="
        sudo docker-compose logs --tail=50 backend

        # Health check
        echo "=== Health Check ==="
        echo "Testing backend (port 8080)..."
        curl -f http://localhost:8080/health || echo "Backend health check failed"

        echo "Testing frontend (port 3000)..."
        curl -f http://localhost:3000 || echo "Frontend health check failed"

        echo "================================"
        echo "âœ… DEVELOPMENT deployment completed!"
        echo "ðŸ”— Backend: http://${{ secrets.EC2_HOST }}:8080"
        echo "ðŸ”— Frontend: http://${{ secrets.EC2_HOST }}:3000"
        echo "ðŸ”— API Docs: http://${{ secrets.EC2_HOST }}:8080/api"
        echo "================================"
        EOF

        # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        scp -o StrictHostKeyChecking=no deploy.sh ubuntu@${{ secrets.EC2_HOST }}:/home/ubuntu/deploy.sh
        ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} "chmod +x /home/ubuntu/deploy.sh && /home/ubuntu/deploy.sh"

    - name: Notify Team on Success
      if: success()
      run: |
        curl -X POST -H 'Content-type: application/json' --data '{
          "text": "ðŸ§ª ê°œë°œ ì„œë²„ ë°°í¬ ì„±ê³µ!\nðŸ“‹ Branch: `ec2test`\nðŸ‘¤ Author: `${{ github.actor }}`\nðŸ”— Backend: http://${{ secrets.EC2_HOST }}:8080\nðŸ”— Frontend: http://${{ secrets.EC2_HOST }}:3000\nðŸ’¡ íŒ€ì›ë“¤ì€ ì´ì œ ì„œë²„ì—ì„œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥í•©ë‹ˆë‹¤!"
        }' ${{ secrets.SLACK_WEBHOOK_URL }}

    - name: Notify Team on Failure
      if: failure()
      run: |
        curl -X POST -H 'Content-type: application/json' --data '{
          "text": "âŒ ê°œë°œ ì„œë²„ ë°°í¬ ì‹¤íŒ¨\nðŸ“‹ Branch: `ec2test`\nðŸ‘¤ Author: `${{ github.actor }}`\nðŸ” GitHub Actionsì—ì„œ ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
        }' ${{ secrets.SLACK_WEBHOOK_URL }}
