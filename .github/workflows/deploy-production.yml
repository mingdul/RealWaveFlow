name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production  # ìˆ˜ë™ ìŠ¹ì¸ í•„ìš”í•œ í™˜ê²½

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Deploy to Production EC2
      run: |
        # SSH í‚¤ ì„¤ì •
        mkdir -p ~/.ssh
        echo "${{ secrets.PROD_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa

        # SSH known_hosts ì„¤ì •
        ssh-keyscan -H ${{ secrets.PROD_EC2_HOST }} >> ~/.ssh/known_hosts

        # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
        cat > deploy.sh << 'EOF'
        #!/bin/bash
        set -e

        echo "ðŸš€ Starting PRODUCTION deployment..."
        cd /home/ubuntu/waveflow

        # ë°±ì—… ìƒì„±
        sudo docker-compose exec backend pg_dump -h $DB_HOST -U $DB_USERNAME $DB_NAME > backup_$(date +%Y%m%d_%H%M%S).sql

        # Git pull
        git remote set-url origin https://${{ secrets.GIT_TOKEN }}@github.com/Team-Honey-Badgers/WaveFlow.git
        git pull origin main

        # .env íŒŒì¼ ìƒì„± (Production í™˜ê²½ë³€ìˆ˜)
        cat > ./backend/.env << 'ENVEOF'
        DB_HOST=${{ secrets.PROD_DB_HOST }}
        DB_PORT=${{ secrets.PROD_DB_PORT }}
        DB_USERNAME=${{ secrets.PROD_DB_USERNAME }}
        DB_PASSWORD=${{ secrets.PROD_DB_PASSWORD }}
        DB_NAME=postgres
        JWT_SECRET=${{ secrets.PROD_JWT_SECRET }}
        RESEND_API_KEY=${{ secrets.PROD_RESEND_API_KEY }}
        FRONTEND_URL=${{ secrets.PROD_FRONTEND_URL }}
        NODE_ENV=production
        # ... ê¸°íƒ€ production í™˜ê²½ë³€ìˆ˜ë“¤
        ENVEOF

        # Docker ë°°í¬ (ë¬´ì¤‘ë‹¨ ë°°í¬)
        sudo docker-compose up -d --no-deps backend
        sleep 30
        sudo docker-compose up -d --no-deps frontend

        echo "âœ… PRODUCTION deployment completed"
        EOF

        # ë°°í¬ ì‹¤í–‰
        scp -o StrictHostKeyChecking=no deploy.sh ubuntu@${{ secrets.PROD_EC2_HOST }}:/home/ubuntu/deploy.sh
        ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.PROD_EC2_HOST }} "chmod +x /home/ubuntu/deploy.sh && /home/ubuntu/deploy.sh"

    - name: Notify Team
      run: |
        curl -X POST -H 'Content-type: application/json' --data '{
          "text": "ðŸš€ PRODUCTION ë°°í¬ ì™„ë£Œ!\nBranch: main\nCommit: ${{ github.sha }}\nURL: https://waveflow.com"
        }' ${{ secrets.SLACK_WEBHOOK_URL }}
