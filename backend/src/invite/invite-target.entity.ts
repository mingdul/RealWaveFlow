import { Entity, PrimaryGeneratedColumn, Column, CreateDateColumn, ManyToOne, JoinColumn } from 'typeorm';
import { InviteBatch } from './invite-batch.entity';

/**
 * InviteTarget 엔티티
 * 
 * 개별 초대 대상자를 관리하는 엔티티
 * 하나의 InviteBatch에 속하는 각각의 초대받은 사람을 나타냄냄
 * 
 * 주요 기능:
 * - 개별 초대 대상자 정보 관리
 * - 고유한 초대 토큰 생성 및 관리
 * - 개별 초대 상태 추적 (대기/수락/거절)
 * - 초대 응답 시간 기록
 * 
 * 비즈니스 로직:
 * - 각 대상자마다 고유한 토큰을 가짐
 * - 이메일 주소로 초대 대상자 식별
 * - 배치와 N:1 관계로 그룹 관리
 * - 응답 시간 추적으로 분석 데이터 제공
 * 
 * 관계:
 * - InviteBatch (N:1): 어떤 배치에 속하는 초대인지
 * 
 * 워크플로우:
 * 1. 배치 생성 시 함께 생성됨
 * 2. 이메일 발송 (토큰 포함)
 * 3. 사용자가 링크 클릭하여 수락/거절
 * 4. 상태 업데이트 및 응답 시간 기록
 */
@Entity('invite_target')
export class InviteTarget {
  /**
   * 초대 대상의 고유 식별자
   * 
   * UUID 형태로 생성되어 예측 불가능한 ID를 보장
   * 
   * 용도:
   * - 개별 초대 대상 식별
   * - 데이터베이스 기본 키
   * - 내부 시스템에서 초대 추적
   * - 로그 및 디버깅 시 참조
   */
  @PrimaryGeneratedColumn('uuid')
  id: string;

  /**
   * 소속 초대 배치
   * 
   * 이 초대 대상이 속한 InviteBatch를 참조
   * onDelete: 'CASCADE'로 설정하여 배치 삭제 시 함께 삭제
   * 
   * 용도:
   * - 배치별 초대 그룹 관리
   * - 트랙 및 초대자 정보 간접 참조
   * - 만료 시간 공유 (배치의 expires_at 사용)
   * - 배치 단위 통계 및 관리
   * 
   * 관계 특징:
   * - N:1 관계 (여러 타겟 : 하나의 배치)
   * - 양방향 관계 (InviteBatch.targets와 연결)
   * - 지연 로딩 (필요할 때만 배치 정보 로드)
   * 
   * 제약사항:
   * - 배치가 삭제되면 관련 타겟들도 자동 삭제
   * - 반드시 하나의 배치에 속해야 함 (null 불가)
   */
  @ManyToOne(() => InviteBatch, batch => batch.targets, { onDelete: 'CASCADE' })
  @JoinColumn({ name: 'invite_batch_id' })
  invite_batch: InviteBatch;

  /**
   * 초대받은 사용자의 이메일 주소
   * 
   * 초대 대상자를 식별하는 핵심 정보
   * 
   * 용도:
   * - 초대 이메일 발송 대상
   * - 사용자 식별 및 매칭
   * - 중복 초대 방지 검증
   * - 회원가입 후 자동 연결
   * 
   * 비즈니스 규칙:
   * - 유효한 이메일 형식이어야 함
   * - 같은 배치 내에서 중복 불가
   * - 대소문자 구분 없이 처리
   * - 트림 처리로 공백 제거
   * 
   * 보안 고려사항:
   * - 개인정보이므로 로그 출력 시 마스킹 필요
   * - GDPR 등 개인정보 보호 규정 준수
   * 
   * 활용 예시:
   * - 이메일 템플릿에서 수신자 표시
   * - 기존 회원 여부 확인
   * - 초대 이력 추적
   */
  @Column({ type: 'varchar' })
  email: string;

  /**
   * 초대 토큰
   * 
   * 각 초대 대상자마다 고유하게 생성되는 보안 토큰
   * UUID v4 형태로 생성되어 예측이 불가능
   * 
   * 용도:
   * - 초대 링크 URL에 포함 (/invite/accept/{token})
   * - 초대 수락/거절 시 인증 수단
   * - 무단 접근 방지
   * - 초대 대상자별 고유 식별
   * 
   * 보안 특징:
   * - 128비트 랜덤 값으로 브루트포스 공격 방지
   * - 예측 불가능한 값으로 무단 접근 차단
   * - 일회성 사용 (응답 후 재사용 불가)
   * - 배치 만료 시간과 연동하여 이중 보안
   * 
   * 생성 규칙:
   * - 각 InviteTarget마다 고유한 토큰
   * - 시스템 전체에서 중복되지 않음
   * - 생성 후 변경 불가
   * 
   * 사용 시나리오:
   * 1. 이메일에 토큰이 포함된 링크 발송
   * 2. 사용자가 링크 클릭
   * 3. 토큰으로 해당 초대 검증
   * 4. 수락/거절 처리 후 상태 업데이트
   */
  @Column({ type: 'uuid' })
  token: string;

  /**
   * 초대 상태
   * 
   * 개별 초대의 현재 상태를 추적합니다.
   * 
   * 상태별 의미:
   * - pending: 초대 발송됨, 응답 대기 중 (기본값)
   * - accepted: 초대 수락됨, 협업자로 등록 완료
   * - declined: 초대 거절됨, 더 이상 처리 불가
   * 
   * 상태 전환:
   * - pending → accepted (초대 수락 시)
   * - pending → declined (초대 거절 시)
   * - accepted/declined는 최종 상태 (변경 불가)
   * 
   * 비즈니스 로직:
   * - pending 상태에서만 수락/거절 가능
   * - 상태 변경 시 responded_at 시간 기록
   * - 배치의 전체 상태에 영향을 미침
   * - 만료 처리는 배치 레벨에서 관리
   * 
   * 용도:
   * - 개별 초대 진행 상황 추적
   * - 배치 완료 여부 계산
   * - 통계 및 분석 데이터
   * - UI에서 상태 표시
   * 
   * 주의사항:
   * - 만료된 초대도 pending 상태 유지 (배치 만료로 판단)
   * - 상태 변경 시 반드시 responded_at 업데이트
   */
  @Column({ default: 'pending' })
  status: 'pending' | 'accepted' | 'declined';

  /**
   * 초대 생성 시간
   * 
   * 개별 초대 대상이 언제 생성되었는지를 기록
   * TypeORM이 자동으로 현재 시간을 설정
   * 
   * 용도:
   * - 개별 초대 이력 추적
   * - 배치 내 초대 순서 확인
   * - 성능 분석 (초대 생성 시간)
   * - 디버깅 및 로그 분석
   * 
   * 활용 예시:
   * - "2시간 전에 받은 초대" 같은 상대적 시간 표시
   * - 초대 응답 시간 계산 (responded_at - created_at)
   * - 배치별 초대 생성 패턴 분석
   * 
   * 주의사항:
   * - 배치 생성 시간과 거의 동일하지만 미세한 차이 있을 수 있음
   * - 시간대 설정에 따라 표시 형식 달라질 수 있음
   */
  @CreateDateColumn({ type: 'timestamp' })
  created_at: Date;

  /**
   * 초대 응답 시간
   * 
   * 사용자가 초대에 응답한 시간을 기록
   * 수락 또는 거절 시점에 자동으로 설정
   * 
   * 특징:
   * - nullable: true로 설정 (응답 전까지는 null)
   * - 상태가 accepted 또는 declined로 변경될 때 설정
   * - 한 번 설정되면 변경되지 않음
   * 
   * 용도:
   * - 초대 응답 속도 분석
   * - 사용자 행동 패턴 분석
   * - 초대 효율성 측정
   * - 응답 시간 통계 생성
   * 
   * 분석 활용:
   * - 평균 응답 시간 계산
   * - 시간대별 응답 패턴 분석
   * - 초대 방식별 응답률 비교
   * - 사용자 참여도 측정
   * 
   * 계산 예시:
   * - 응답 시간 = responded_at - created_at
   * - 빠른 응답 = 1시간 이내
   * - 늦은 응답 = 12시간 이후
   * 
   * 비즈니스 인사이트:
   * - 어떤 시간대에 초대를 보내야 빠른 응답을 받을 수 있는지
   * - 초대 메시지 개선 효과 측정
   * - 사용자별 응답 패턴 파악
   */
  @Column({ type: 'timestamp', nullable: true })
  responded_at: Date;
}
